CAP定理

> 当分布式系统中一定会出现分区，当分区出现的时候，一致性和可用性只能选一。

base理论

> 1. 基本可用：运行损失部分可用性，保证核心可用
> 2. 软状态：允许临时不一致
> 3. 最终一致性。

分布式事务借鉴了这种理论

1. AP模式：各子事务分别执行和提交，允许出现结果不一致，然后采用弥补措施恢复数据即可，实现最终一致。
2. CP模式：各个子事务执行后互相等待，同时提交，同时回滚，达成强一致。但事务等待过程中，处于弱可用状态。

#### Seata

> -  TC(Transaction Coordinator)事务协调者
> - TM (Transaction Manager)-事务管理器
> - RM (Resource Manager)-资源管理器
>
> Seata提供了四种不同的分布式事务解决方案
>
> 1. XA模式：强一致性的分阶段事务模式，牺牲了一定的可用性，无业务入侵
> 2. TCC模式：最终一致的分阶段事务模式，有业务侵入
> 3. AT模式：最终一致性的分阶段事务模式，无业务入侵，也是seata的默认模式
> 4. SAGA模式 ：长事务模式，有业务入侵

##### TC服务安装

> ##### 注册到注册中心

```java
registry{

}
config{
  
}
```

#### XA事务 (强一致性的事务JTA)

> XA规范是x/Open 组织定义的分布式事务处理 (DTP， Distributed Transaction Processing)）标准，xA 规范描述了全局的TM与局部的RM之间的接口，几乎所有主流的数据库都对 XA规范提供了支持。
>
> 基于二阶段提交:
>
> 1. 第一阶段事务协调者 提醒准备，准备就绪
> 2. 第二阶段回滚 已回滚
>
> ![image-20250921165603865](https://leslieyedoc.oss-cn-shanghai.aliyuncs.com/img/20250921-165606-image-20250921165603865.png)
>
> XA模式优点
>
> - 事务的强一致性，满足ACID的原理
> - 常用数据库都支持，实现简单，并且没有代码入侵
>
> XA模式缺点
>
> - 第一阶段需要锁定数据库资源，等待二阶段结束才释放
> - 依赖关系型数据库事务
>
> 实现XA模式
>
> ![image-20250921170041444](https://leslieyedoc.oss-cn-shanghai.aliyuncs.com/img/20250921-170044-image-20250921170041444.png)

#### AT模式 代码0侵入

> ![image-20250921170517468](https://leslieyedoc.oss-cn-shanghai.aliyuncs.com/img/20250921-170521-image-20250921170517468.png)
>
> AT模式的脏读问题，利用写隔离解决。
>
> ![image-20250921171853906](https://leslieyedoc.oss-cn-shanghai.aliyuncs.com/img/20250921-171856-image-20250921171853906.png

TCC模式

> TCC模式与AT模式非常相似，每阶段都是独立事务，不同的是TCC通过人工编码来实现数据恢复。需要实现三个方法:
>
> - Try：资源的检测和预留；
>
> - Confirm：完成资源操作业务；要求Try 成功 Confirm一定要能成功。
>
> - Cancel：预留资源释放，可以理解为try的反向操作。
>
>   <img src="https://leslieyedoc.oss-cn-shanghai.aliyuncs.com/img/20250921-172731-image-20250921172728845.png" alt="image-20250921172728845" style="zoom:33%;" />
>
>   ![image-20250921172930888](https://leslieyedoc.oss-cn-shanghai.aliyuncs.com/img/20250921-172935-image-20250921172930888.png)

#### Saga模式

![image-20250921193022291](https://leslieyedoc.oss-cn-shanghai.aliyuncs.com/img/20250921-193028-image-20250921193022291.png)

几种对比

![image-20250921193047268](https://leslieyedoc.oss-cn-shanghai.aliyuncs.com/img/20250921-193050-image-20250921193047268.png)