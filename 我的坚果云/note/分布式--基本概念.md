- 服务注册和发现

  - 引入服务注册与发现组件的原因

    - 先来看一个问题，假如现在我们要做一个商城项目，作为架构师的你应该怎样设计系统的架构？你心里肯定在想：这还不容易直接照搬淘宝的架构不就行了。但在现实的创业环境中一个项目可能是九死一生，如果一开始投入巨大的人力和财力，一旦项目失败损失就很大。

    - 作为一位有经验的架构师需要结合公司财力、人力投入预算等现状选择最适合眼下的架构才是王道。大型网站都是从小型网站发展而来，架构也是一样。

    - 任何一个大型网站的架构都不是从一开始就一层不变的，而是随着用户量和数据量的不断增加不断迭代演进的结果。

    - 在架构不断迭代演进的过程中我们会遇到很多问题，技术发展的本质就是不断发现问题再解决问题，解决问题又发现问题。

  - 单体架构

  - 集群部署

    ![img](https://leslieyedoc.oss-cn-shanghai.aliyuncs.com/img/20250927-131831-8209378_73cd2332-f0d7-419f-a7ad-dabb1962c0f9.png)

  - 微服务架构

    ![img](https://leslieyedoc.oss-cn-shanghai.aliyuncs.com/img/20250927-131847-8209378_7c4b9133-816b-46e4-c757-99931dd5b4d5.png)

  - 服务注册与发现基本原理

    - 服务注册：服务进程在注册中心注册自己的元数据信息。通常包括主机和端口号，有时还有身份验证信息，协议，版本号，以及运行环境的信息。

    - 服务发现：客户端服务进程向注册中心发起查询，来获取服务的信息。服务发现的一个重要作用就是提供给客户端一个可用的服务列表。

  - 服务注册

    - 客户端注册
      - 客户端注册是服务自己要负责注册与注销的工作。当服务启动后注册线程向注册中心注册，当服务下线时注销自己。

    - 代理注册
      - 代理注册由一个单独的代理服务负责注册与注销。当服务提供者启动后以某种方式通知代理服务，然后代理服务负责向注册中心发起注册工作。

  - 服务发现

    - 客户端发现
      - 客户端发现是指客户端负责向注册中心查询可用服务地址，获取到所有的可用实例地址列表后客户端根据负载均衡算法选择一个实例发起请求调用。

    - 代理发现

  - 心跳机制

    - 如果服务有多个实例，其中一个实例出现宕机，注册中心是可以实时感知到，并且将该实例信息从列表中移出，也称为摘机。

    - 如何实现摘机？业界比较常用的方式是通过心跳检测的方式实现，心跳检测有主动和被动两种方式

      - 被动检测是指服务主动向注册中心发送心跳消息，时间间隔可自定义，比如配置5秒发送一次，注册中心如果在三个周期内比如说15秒内没有收到实例的心跳消息，就会将该实例从列表中移除。

      - 主动检测是注册中心主动发起，每隔几秒中会给所有列表中的服务实例发送心跳检测消息，如果多个周期内未发送成功或未收到回复就会主动移除该实例。

    - 业界常用的服务注册与发现组件对比

      - eureka，eureka在2018年已经宣布放弃维护

      - zookeeper，consul，etcd

    - Consul——值得推荐的服务注册与发现开源组件

      - Consul有哪些优势？

        - 服务注册发现：Consul提供了通过DNS或者restful接口的方式来注册服务和发现服务。服务可根据实际情况自行选择。

        - 健康检查：Consul的Client可以提供任意数量的健康检查，既可以与给定的服务相关联，也可以与本地节点相关联。

        - 多数据中心：Consul支持多数据中心，这意味着用户不需要担心Consul自身的高可用性问题以及多数据中心带来的扩展接入等问题。

          ![img](https://leslieyedoc.oss-cn-shanghai.aliyuncs.com/img/20250927-131904-8209378_7cd2b194-0f3e-4154-a72c-bb333c02df63.png)

      - Consul 实现多数据中心依赖于gossip protocol协议。这样做的目的：

        - 不需要使用服务器的地址来配置客户端；服务发现是自动完成的。

        - 健康检查故障的工作不是放在服务器上，而是分布式的。

      - Consul的使用场景

        - Consul的应用场景包括服务注册发现、服务隔离、服务配置等。

        - 服务注册发现场景中consul作为注册中心，服务地址被注册到consul中以后，可以使用consul提供的dns、http接口查询，consul支持health check。

        - 服务隔离场景中consul支持以服务为单位设置访问策略，能同时支持经典的平台和新兴的平台，支持tls证书分发，service-to-service加密。

        - 服务配置场景中consul提供key-value数据存储功能，并且能将变动迅速地通知出去，借助Consul可以实现配置共享，需要读取配置的服务可以从Consul中读取到准确的配置信息。

- 访问网站的过程

  - DNS
    - 先尝试从host文件中读取域名对应的IP地址，如果找到，则完毕；如果未找到，则使用DNS进行查找。

  - TCP
    - 三次握手建立连接

  - 负载均衡服务器
    - Nginx?

  - 应用服务器
    - Tomcat?

  - 浏览器渲染
    - 缓存？

- 大型网站架构演进

  - 1)单机

  - 2)单机负载告警，数据库与应用分离

  - 3)应用服务器负载告警，让应用服务器走向集群

    - 1)引入负载均衡设备

    - 2)分布式Session

      - Session Sticky 会话粘滞

      - Session Replication 会话复制

      - Session 集中存储

      - Cookie Based

  - 4)数据库读压力变大，读写分离

    - 1)数据库主从复制

    - 2)搜索引擎

    - 3)分布式缓存

  - 5)弥补关系数据库的不足，引入分布式存储系统

  - 6)数据库又遇瓶颈，分库分表

    - 1)垂直拆分——分库

      - 按业务分库

      - 需要解决表关联和分布式事务问题

    - 2)水平拆分——分表

  - 7)应用拆分与服务化

    - 1)应用拆分

    - 2)服务化

  - 8)消息中间件（异步+解耦)

  - 9)CDN

    - 内容分发网络。作用是把用户需要的内容分发到离用户近的地方，这样可以使用户能够就近获取所需内容。整个CDN系统分为CDN源站和CDN节点，CDN源站提供CDN节点使用的数据源头，而CDN节点则部署在距离最终用户比较近的地方，加速用户对站点的访问。

    - CDN其实就是一种网络缓存技术，能够把一些相对稳定的资源放到距离最终用户较近的机房，一方面可以节省整个广域网的带宽开销，另一方面可以提升用户的访问速度，改进用户体验。我们一般把一些相对静态的文件放在CDN中。

    - 引入CDN后浏览器访问网站的流程

- 大型网站核心架构要素

  - 网站性能指标（PV QPS TPS 吞吐量 响应时间)

  - 吞吐量（还有QPS TPS)
    - 指单位时间内系统处理的请求数量，体现系统的整体处理能力。对于网站，可以用请求数/秒，或者页面数/每秒来衡量，也可以用访问人数/天，或者处理的业务数/小时等来衡量。TPS（每秒事务数)是吞吐量的一个常用量化指标，此外还有QPS（每秒查询数)、HPS（每秒HTTP请求数)等。

  - Web性能优化

    - 前端优化

      - 1)浏览器缓存

      - 2)HTTP请求合并

      - 3)CSS、JS、图片等资源合并压缩

      - 4)CDN

      - 5)页面静态化

      - 6)减少Cookie传输

    - 服务端优化

      - 1)接入层：反向代理，负载均衡

      - 2)应用服务器集群

      - 3)缓存：分布式缓存

      - 4)数据库优化，查询优化，索引，主从复制，读写分离，分库分表

      - 5)分布式消息队列，异步操作

    - 影响单机并发量的因素与优化

      - CPU消耗严重的解决办法：1)减少阻塞，同步转异步，队列等 2)减少线程数，避免大量时间消耗着线程上下文切换上3)降低锁的竞争，尽可能采用lock-free、non-blocking的方式

      - 文件IO消耗严重的解决办法：1)异步写文件2)批量读写3)限流，比如放入队列4)限制文件大小 5)缓存6)RAID

      - 内存消耗严重的解决办法：1)使用不必要的引用2)使用对象缓存池3)使用合理的缓存失效算法

      - 网络IO消耗严重的解决办法：1)减少网络交互次数2)减少网络传输数据量的大小3)尽量采用异步非阻塞的方式

  - 抢购/超卖问题

    - 前端

      - 页面静态化

      - CDN

      - 禁止用户重复提交请求

    - 接入层

      - 限制同一个IP的访问频率

      - 页面缓存

    - 服务层

      - 避免恶意刷单，直接绕过App/网页：每个表单分配Token，

      - 可以考虑随机将部分请求直接返回失败

      - 数据库悲观锁更新库存

    - 数据层
      - 主从复制，读写分离，分库分表

    - 负载均衡的演进整合
      - SSL带来的负载均衡变化

    - 负载均衡算法

      - 轮询（Round Robin，RR)

      - 加权轮询（Weighted Round Robin，WRR)

      - 随机（Random)

      - 最少连接（Least Connections)

      - 源地址散列（Source Hashing)

    - 安全性

      - XSS

      - SQL注入

      - CSRF

      - 其他

    - 分类算法
      - 贝叶斯分类算法

    - 黑名单
      - hash表，但是会占用很多内存，如果hash表过大就无法解决了。

- 链路追踪

  - 什么是链路追踪？
    - 分布式链路追踪就是将一次分布式请求还原成调用链路，将一次分布式请求的调用情况集中展示，比如各个服务节点上的耗时、请求具体到达哪台机器上、每个服务节点的请求状态等等。

  - 链路跟踪主要功能：

    - 故障快速定位：可以通过调用链结合业务日志快速定位错误信息。

    - 链路性能可视化：各个阶段链路耗时、服务依赖关系可以通过可视化界面展现出来。

    - 链路分析：通过分析链路耗时、服务依赖关系可以得到用户的行为路径，汇总分析应用在很多业务场景。

  - 链路追踪基本原理

  - 业界常用链路追踪系统

    - 如Twitter的Zipkin，

    - Uber的Jaeger，

    - pinpoint，

    - Apache开源的skywalking，

    - 还有国产如阿里的鹰眼，

    - 美团的Mtrace，

    - 滴滴Trace，

    - 新浪的Watchman，

    - 京东的Hydra，

    - 附各大开源组件的地址：

      - zipkin[https://zipkin.io/](https://zipkin.io/?fileGuid=Q8RQjVxpcvdvtC6q)

      - Jaeger[www.](http://www.baidu.com/link?url=BktsXcEs4Z1Ci_M7bV8PsKC3PZLoGVDS-omdih46FUB5HP4XXSbzSQRJW-Z0cqps&fileGuid=Q8RQjVxpcvdvtC6q)[jaeger](http://www.baidu.com/link?url=BktsXcEs4Z1Ci_M7bV8PsKC3PZLoGVDS-omdih46FUB5HP4XXSbzSQRJW-Z0cqps&fileGuid=Q8RQjVxpcvdvtC6q)[tracing.io/](http://www.baidu.com/link?url=BktsXcEs4Z1Ci_M7bV8PsKC3PZLoGVDS-omdih46FUB5HP4XXSbzSQRJW-Z0cqps&fileGuid=Q8RQjVxpcvdvtC6q)

      - Pinpoint[https://github.com/pinpoint-apm/pinpoint](https://github.com/pinpoint-apm/pinpoint?fileGuid=Q8RQjVxpcvdvtC6q)

      - SkyWalking[http://skywalking.apache.org/](http://skywalking.apache.org/?fileGuid=Q8RQjVxpcvdvtC6q)

    - 分布式链路追踪系统Zipkin实现

      

      ![img](https://leslieyedoc.oss-cn-shanghai.aliyuncs.com/img/20250927-131925-8209378_b78011d7-aded-481f-f620-c68689d3b072.png)

      ![img](https://api2.mubu.com/v3/document_image/8209378_1adfda2c-51e7-48d4-bb34-5449bdb6e9b9.png)

      

      

  - 在服务运行的过程中会产生很多链路信息，产生数据的地方可以称之为Reporter。将链路信息通过多种传输方式如HTTP，RPC，kafka消息队列等发送到Zipkin的采集器，Zipkin处理后最终将链路信息保存到存储器中。运维人员通过UI界面调用接口即可查询调用链信息。

    1. Collector
       - 一旦Collector采集线程获取到链路追踪数据，Zipkin就会对其进行验证、存储和索引，并调用存储接口保存数据，以便进行查找。

    2. Storage
       - Zipkin Storage最初是为了在Cassandra上存储数据而构建的，因为Cassandra是可伸缩的，具有灵活的模式，并且在Twitter中大量使用。除了Cassandra，还支持支持ElasticSearch和MySQL存储，后续可能会提供第三方扩展。

    3. Query Service
       - 链路追踪数据被存储和索引之后，webui 可以调用query service查询任意数据帮助运维人员快速定位线上问题。query service提供了简单的json api来查找和检索数据。

    4. Web UI
       - Zipkin 提供了基本查询、搜索的web界面，运维人员可以根据具体的调用链信息快速识别线上问题。

  - 总结

    - 分布式链路追踪就是将每一次分布式请求还原成调用链路。

    - 链路追踪的核心概念：Trace、Span、Annotation、带内和带外数据、采样、存储。

    - 业界常用的开源组件都是基于谷歌Dapper论文演变而来；

    - Zipkin核心组件有：Collector、Storage、Query Service、Web UI。

- 华为分布式软总线

  - 传统总线知识

    - 总线是一种内部结构，它是cpu、内存、输入、输出设备传递信息的公用通道，主机的各个部件通过总线相连接，外部设备通过相应的接口电路再与总线相连接，从而形成了计算机硬件系统。

      ![img](https://leslieyedoc.oss-cn-shanghai.aliyuncs.com/img/20250927-132112-8209378_d8ca16cc-5617-4453-8dd8-0f9df3ad0912.png)

    - 在计算机系统中，各个部件之间传送信息的公共通路叫总线，微型计算机是以总线结构来连接各个功能部件的。按照计算机所传输的信息种类，计算机的总线可以划分为数据总线、地址总线和控制总线，分别用来传输数据、数据地址和控制信号。

  - 什么是分布式软总线？
    - 分布式软总线技术是基于华为多年的通信技术积累，参考计算机硬件总线，在1+8+N设备间搭建一条“无形”的总线，具备自发现、自组网、高带宽低时延的特点。
      - 1指的是手机8代表车机、音箱、耳机、手表/手环、平板、大屏、PC、AR/VRN泛指其他IOT设备

  - 分布式软总线功能和原理

    - 分布式软总线的架构

      - 通过协议货架和软硬协同层屏蔽各种设备的协议差别，总线中枢模块负责解析命令完成设备间发现和连接，通过任务和数据两条总线实现设备间文件传输、消息传输等功能。

      - 分布式总线的总体目标是实现设备间无感发现，零等待传输。实现这个目标需要解决三个问题：

        - 1）设备间如何发现和连接？

        - 2）多设备互联后如何组网？

        - 3）多设备多协议间如何实现传输？

    - 软总线之发现连接：从手动发现，进化成自发现

    - 软总线组网关键技术-异构网络组网

    - 软总线之传输