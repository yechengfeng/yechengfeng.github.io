- 节点角色说明

  - Provider	暴露服务的服务提供方

  - Consumer	调用远程服务的服务消费方

  - Registry	服务注册与发现的注册中心

  - Monitor	统计服务的调用次调和调用时间的监控中心

  - Container	服务运行容器

- 调用关系说明

  - 1.- 服务容器负责启动，加载，运行服务提供者。

  - 2.- 服务提供者在启动时，向注册中心注册自己提供的服务。

  - 3.- 服务消费者在启动时，向注册中心订阅自己所需的服务。

  - 4.- 注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于长连接推送变更数据给消费者。

  - 5.- 服务消费者，从提供者地址列表中，基于软负载均衡算法，选一台提供者进行调用，如果调用失败，再选另一台调用。

  - 6.- 服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心。

- 连通性

  - 1.- 注册中心负责服务地址的注册与查找，相当于目录服务，服务提供者和消费者只在启动时与注册中心交互，注册中心不转发请求，压力较小

  - 2.- 监控中心负责统计各服务调用次数，调用时间等，统计先在内存汇总后每分钟一次发送到监控中心服务器，并以报表展示

  - 3.- 服务提供者向注册中心注册其提供的服务，并汇报调用时间到监控中心，此时间不包含网络开销

  - 4.- 服务消费者向注册中心获取服务提供者地址列表，并根据负载算法直接调用提供者，同时汇报调用时间到监控中心，此时间包含网络开销

  - 5.- 注册中心，服务提供者，服务消费者三者之间均为长连接，监控中心除外

  - 6.- 注册中心通过长连接感知服务提供者的存在，服务提供者宕机，注册中心将立即推送事件通知消费者

  - 7.- 注册中心和监控中心全部宕机，不影响已运行的提供者和消费者，消费者在本地缓存了提供者列表

  - 8.- 注册中心和监控中心都是可选的，服务消费者可以直连服务提供者

- 健状性

  - 1.- 监控中心宕掉不影响使用，只是丢失部分采样数据

  - 2.- 数据库宕掉后，注册中心仍能通过缓存提供服务列表查询，但不能注册新服务

  - 3.- 注册中心对等集群，任意一台宕掉后，将自动切换到另一台

  - 4.- 注册中心全部宕掉后，服务提供者和服务消费者仍能通过本地缓存通讯

  - 5.- 服务提供者无状态，任意一台宕掉后，不影响使用

  - 6.- 服务提供者全部宕掉后，服务消费者应用将无法使用，并无限次重连等待服务提供者恢复

- 伸缩性

  - 1.- 注册中心为对等集群，可动态增加机器部署实例，所有客户端将自动发现新的注册中心

  - 2.- 服务提供者无状态，可动态增加机器部署实例，注册中心将推送新的服务提供者信息给

- 负载均衡

  - Random LoadBalance 随机，按权重设置随机概率。

  - RoundRobin LoadBalance 轮循，按公约后的权重设置轮循比率

  - ConsistentHash LoadBalance 一致性 Hash，相同参数的请求总是发到同一提供者。

  - 线程模型
    - <dubbo:protocol name="dubbo" dispatcher="all"  threadpool="fixed" threads="100" />
      - Dispatcher

- 协议

- 常见问题

  - 为什么要消费者比提供者个数多?

    - https://blog.csdn.net/luzhensmart/article/details/113063845

    - 为什么要消费者比提供者个数多? 因dubbo 协议采用单一长连接，假设网络为千兆网卡 3，根据测试经验数据每条连接最多只能压满7MByte(不同的环境可能不一样，供参考)，理论上1 个服务提供者需要20 个服务消费者才能压满网卡

  - 为什么不能传大包?
    - 为什么不能传大包? 因dubbo 协议采用单一长连接，如果每次请求的数据包大小为500KByte，假设网络为千兆网卡 3，每条连接最大7MByte(不同的环境可能不一样，供参考)，单个服务提供者的TPS(每秒处理事务数)最大为：128MByte / 500KByte = 262。

  - 为什么采用异步单一长连接?

    - https://www.iamshuaidi.com/39928.html

    - Dubbo 协议采用异步单一长连接的方式，主要是为了提高系统的性能、降低连接数、减少网络开销以及提升请求响应的效率。在这种模式下，客户端与服务端之间使用一个持久的连接，通过异步机制处理请求和响应，这种方式相比传统的同步阻塞模式具有更好的吞吐量和并发处理能力。fen

- 令牌验证

  - 通过令牌验证在注册中心控制权限，以决定要不要下发令牌给消费者，可以防止消费者绕过注册中心访问提供者，另外通过注册中心可灵活改变授权方式，而不需修改或升级提供者

  - 可以全局设置开启令牌验证：

    - <dubbo:provider interface="com.foo.BarService" token="true" />随机token令牌，使用UUID生成

    - <dubbo:provider interface="com.foo.BarService" token="123456" />固定token

  - 也可在服务级别设置：

    - <dubbo:service interface="com.foo.BarService" token="true" />

    - <dubbo:service interface="com.foo.BarService" token="123456" />

  - 还可在协议级别设置：

    - <dubbo:protocol name="dubbo" token="true" />

    - <dubbo:protocol name="dubbo" token="123456" />

- 优雅停机

  - Dubbo 是通过 JDK 的 ShutdownHook 来完成优雅停机的，所以如果用户使用 kill -9 PID等强制关闭指令，是不会执行优雅停机的，只有通过 kill PID 时，才会执行。